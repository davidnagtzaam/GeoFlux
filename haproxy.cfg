global
    log stdout format raw local0 info
    maxconn 4096
    user haproxy
    group haproxy
    daemon

defaults
    log global
    mode http
    option httplog
    option dontlognull
    option forwardfor
    timeout connect 10s
    timeout client 300s
    timeout server 300s
    timeout tunnel 3600s
    retries 3

# Statistics interface
listen stats
    bind *:8404
    mode http
    stats enable
    stats uri /
    stats refresh 30s
    stats show-legends
    stats show-node

# Main proxy frontend with header-based routing
frontend main_proxy
    bind *:8888
    mode http

    # Optional Basic Authentication (controlled by environment variable)
    # Uncomment the line below and set credentials in your environment if needed
    # acl auth_ok http_auth(basic_auth)
    # http-request auth realm GeoFlux if !auth_ok

    # Header-based country routing using X-Exit-Country
    acl route_nl hdr(X-Exit-Country) -i nl netherlands
    acl route_us hdr(X-Exit-Country) -i us usa unitedstates united-states
    acl route_de hdr(X-Exit-Country) -i de germany deutschland
    acl route_no hdr(X-Exit-Country) -i no norway norge
    acl route_uk hdr(X-Exit-Country) -i uk gb united-kingdom unitedkingdom
    acl route_ee hdr(X-Exit-Country) -i ee estonia eesti
    acl route_lv hdr(X-Exit-Country) -i lv latvia latvija
    acl route_se hdr(X-Exit-Country) -i se sweden sverige
    acl route_fi hdr(X-Exit-Country) -i fi finland suomi
    acl route_ch hdr(X-Exit-Country) -i ch switzerland schweiz
    acl route_fr hdr(X-Exit-Country) -i fr france
    acl route_es hdr(X-Exit-Country) -i es spain espana
    acl route_it hdr(X-Exit-Country) -i it italy italia
    acl route_ca hdr(X-Exit-Country) -i ca canada
    acl route_au hdr(X-Exit-Country) -i au australia

    # Route to appropriate backend based on header
    use_backend gluetun_nl if route_nl
    use_backend gluetun_us if route_us
    use_backend gluetun_de if route_de
    use_backend gluetun_no if route_no
    use_backend gluetun_uk if route_uk
    use_backend gluetun_ee if route_ee
    use_backend gluetun_lv if route_lv
    use_backend gluetun_se if route_se
    use_backend gluetun_fi if route_fi
    use_backend gluetun_ch if route_ch
    use_backend gluetun_fr if route_fr
    use_backend gluetun_es if route_es
    use_backend gluetun_it if route_it
    use_backend gluetun_ca if route_ca
    use_backend gluetun_au if route_au

    # Default to Netherlands if no header or unrecognized country
    default_backend gluetun_nl

# Port-based frontends for direct country access

# Netherlands - Port 8891
frontend port_nl
    bind *:8891
    mode http
    default_backend gluetun_nl

# United States - Port 8892
frontend port_us
    bind *:8892
    mode http
    default_backend gluetun_us

# Germany - Port 8893
frontend port_de
    bind *:8893
    mode http
    default_backend gluetun_de

# Norway - Port 8894
frontend port_no
    bind *:8894
    mode http
    default_backend gluetun_no

# United Kingdom - Port 8895
frontend port_uk
    bind *:8895
    mode http
    default_backend gluetun_uk

# Estonia - Port 8896
frontend port_ee
    bind *:8896
    mode http
    default_backend gluetun_ee

# Latvia - Port 8897
frontend port_lv
    bind *:8897
    mode http
    default_backend gluetun_lv

# Sweden - Port 8898
frontend port_se
    bind *:8898
    mode http
    default_backend gluetun_se

# Finland - Port 8899
frontend port_fi
    bind *:8899
    mode http
    default_backend gluetun_fi

# Switzerland - Port 8900
frontend port_ch
    bind *:8900
    mode http
    default_backend gluetun_ch

# France - Port 8901
frontend port_fr
    bind *:8901
    mode http
    default_backend gluetun_fr

# Spain - Port 8902
frontend port_es
    bind *:8902
    mode http
    default_backend gluetun_es

# Italy - Port 8903
frontend port_it
    bind *:8903
    mode http
    default_backend gluetun_it

# Canada - Port 8904
frontend port_ca
    bind *:8904
    mode http
    default_backend gluetun_ca

# Australia - Port 8905
frontend port_au
    bind *:8905
    mode http
    default_backend gluetun_au

# Backend definitions for all country VPN tunnels

backend gluetun_nl
    mode http
    balance roundrobin
    option httpchk GET /
    server gluetun-nl gluetun-nl:8888 check inter 30s fall 3 rise 2

backend gluetun_us
    mode http
    balance roundrobin
    option httpchk GET /
    server gluetun-us gluetun-us:8888 check inter 30s fall 3 rise 2

backend gluetun_de
    mode http
    balance roundrobin
    option httpchk GET /
    server gluetun-de gluetun-de:8888 check inter 30s fall 3 rise 2

backend gluetun_no
    mode http
    balance roundrobin
    option httpchk GET /
    server gluetun-no gluetun-no:8888 check inter 30s fall 3 rise 2

backend gluetun_uk
    mode http
    balance roundrobin
    option httpchk GET /
    server gluetun-uk gluetun-uk:8888 check inter 30s fall 3 rise 2

backend gluetun_ee
    mode http
    balance roundrobin
    option httpchk GET /
    server gluetun-ee gluetun-ee:8888 check inter 30s fall 3 rise 2

backend gluetun_lv
    mode http
    balance roundrobin
    option httpchk GET /
    server gluetun-lv gluetun-lv:8888 check inter 30s fall 3 rise 2

backend gluetun_se
    mode http
    balance roundrobin
    option httpchk GET /
    server gluetun-se gluetun-se:8888 check inter 30s fall 3 rise 2

backend gluetun_fi
    mode http
    balance roundrobin
    option httpchk GET /
    server gluetun-fi gluetun-fi:8888 check inter 30s fall 3 rise 2

backend gluetun_ch
    mode http
    balance roundrobin
    option httpchk GET /
    server gluetun-ch gluetun-ch:8888 check inter 30s fall 3 rise 2

backend gluetun_fr
    mode http
    balance roundrobin
    option httpchk GET /
    server gluetun-fr gluetun-fr:8888 check inter 30s fall 3 rise 2

backend gluetun_es
    mode http
    balance roundrobin
    option httpchk GET /
    server gluetun-es gluetun-es:8888 check inter 30s fall 3 rise 2

backend gluetun_it
    mode http
    balance roundrobin
    option httpchk GET /
    server gluetun-it gluetun-it:8888 check inter 30s fall 3 rise 2

backend gluetun_ca
    mode http
    balance roundrobin
    option httpchk GET /
    server gluetun-ca gluetun-ca:8888 check inter 30s fall 3 rise 2

backend gluetun_au
    mode http
    balance roundrobin
    option httpchk GET /
    server gluetun-au gluetun-au:8888 check inter 30s fall 3 rise 2

# Basic auth userlist (uncomment and configure if needed)
# userlist basic_auth
#     user admin password $5$rounds=535000$yourhashhere
